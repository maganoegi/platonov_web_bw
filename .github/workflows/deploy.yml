name: ðŸš€ Release Frontend â†’ Upload to S3 â†’ Invalidate CloudFront

on:
  workflow_dispatch:
    inputs:
      bump:
        description: "Which part of the version to bump?"
        type: choice
        required: true
        default: patch
        options: [patch, minor, major]

permissions:
  contents: write    # push tags
  id-token: write    # OIDC to AWS

concurrency:
  group: release-frontend
  cancel-in-progress: false

jobs:
  release:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    environment:
      name: production

    env:
      TAG_PREFIX: v

      # Prefer environment secrets; keep these as environment-scoped secrets:
      AWS_REGION: ${{ secrets.AWS_REGION }}
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}
      FRONTEND_S3_BUCKET: ${{ secrets.FRONTEND_S3_BUCKET }}
      CLOUDFRONT_DISTRIBUTION_ID: ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }}

    steps:
      - name: Checkout main (full history + tags)
        uses: actions/checkout@v5
        with:
          ref: main
          fetch-depth: 0

      - name: Fetch tags
        run: git fetch --tags --force

      - name: Configure git identity (annotated tags)
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Compute next version from tags
        id: ver
        env:
          BUMP: ${{ inputs.bump }}
          PREFIX: ${{ env.TAG_PREFIX }}
        run: |
          python - <<'PY'
          import os, re, subprocess

          bump = os.environ["BUMP"]
          prefix = os.environ["PREFIX"]

          try:
            out = subprocess.check_output(
              ["git", "tag", "--list", f"{prefix}[0-9]*.[0-9]*.[0-9]*", "--sort=version:refname"],
              text=True
            ).strip().splitlines()
          except subprocess.CalledProcessError:
            out = []

          current_tag = out[-1] if out else f"{prefix}0.0.0"
          m = re.match(rf"^{re.escape(prefix)}(\d+)\.(\d+)\.(\d+)$", current_tag)
          if not m:
            raise SystemExit(f"Latest tag '{current_tag}' does not match {prefix}X.Y.Z")

          major, minor, patch = map(int, m.groups())
          if bump == "major":
            major, minor, patch = major + 1, 0, 0
          elif bump == "minor":
            minor, patch = minor + 1, 0
          elif bump == "patch":
            patch = patch + 1
          else:
            raise SystemExit(f"Unknown bump: {bump}")

          new_version = f"{major}.{minor}.{patch}"
          new_tag = f"{prefix}{new_version}"

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as f:
            f.write(f"current_tag={current_tag}\n")
            f.write(f"version={new_version}\n")
            f.write(f"tag={new_tag}\n")
          PY

      - name: Create local annotated tag (do NOT push yet)
        env:
          TAG: ${{ steps.ver.outputs.tag }}
        run: |
          set -euo pipefail
          echo "$TAG" > "$RUNNER_TEMP/release_tag"
          git tag -a "$TAG" -m "Release $TAG"
          echo "Local tag created: $TAG"

      # ---- Build ----
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Build (Vite)
        run: npm run build
        env:
          APP_VERSION: ${{ steps.ver.outputs.version }}

      # ---- AWS (OIDC) ----
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          mask-aws-account-id: true
          unset-current-credentials: true

      # ---- Upload to S3 (cache smart) ----
      - name: Upload to S3 (assets long-cache, index no-cache)
        env:
          BUCKET: ${{ env.FRONTEND_S3_BUCKET }}
        run: |
          set -euo pipefail

          test -d dist || (echo "dist/ not found. Did the build step run?" && exit 1)

          # 1) Hashed assets: cache forever
          aws s3 sync dist "s3://${BUCKET}/" \
            --delete \
            --only-show-errors \
            --cache-control "public,max-age=31536000,immutable" \
            --exclude "index.html" \
            --exclude "*.html"

          # 2) index.html: no cache (so releases appear fast)
          aws s3 cp dist/index.html "s3://${BUCKET}/index.html" \
            --only-show-errors \
            --cache-control "no-cache, no-store, must-revalidate" \
            --content-type "text/html; charset=utf-8"

      # ---- CloudFront invalidation ----
      - name: CloudFront invalidation
        env:
          DIST_ID: ${{ env.CLOUDFRONT_DISTRIBUTION_ID }}
        run: |
            echo "no cloudfront to invalidate yet..."
        #   set -euo pipefail
        #   # Hashed assets rarely need invalidation; index.html usually enough.
        #   aws cloudfront create-invalidation \
        #     --distribution-id "$DIST_ID" \
        #     --paths "/index.html" "/*"

      # Only mark release after successful deploy
      - name: Push tag to origin
        env:
          TAG: ${{ steps.ver.outputs.tag }}
        run: |
          set -euo pipefail
          git push origin "refs/tags/$TAG"
          echo "âœ… Tag pushed: $TAG"

      - name: Summary
        if: always()
        env:
          TAG: ${{ steps.ver.outputs.tag }}
          BUCKET: ${{ env.FRONTEND_S3_BUCKET }}
          DIST_ID: ${{ env.CLOUDFRONT_DISTRIBUTION_ID }}
        run: |
          {
            echo "## Frontend Release Summary"
            echo ""
            echo "- Tag: \`$TAG\`"
            echo "- S3 bucket: \`$BUCKET\`"
            echo "- CloudFront distribution: \`$DIST_ID\`"
            echo "- API base URL baked into build: \`$API_URL\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Cleanup local tag on failure
        if: failure()
        run: |
          set -euo pipefail
          TAG=""
          if [ -f "$RUNNER_TEMP/release_tag" ]; then TAG="$(cat "$RUNNER_TEMP/release_tag")"; fi
          if [ -n "$TAG" ]; then
            echo "Deleting local tag: $TAG"
            git tag -d "$TAG" || true
          fi
